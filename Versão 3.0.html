<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://raw.githubusercontent.com/AlexYagam1/MeuBlog/refs/heads/main/images/Icon%20compesa.ico">
    <title>GCC - Junta guias</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

</head>
<body>
    <header>
        <h1>JUNTA GUIAS</h1>
        <p>Junte as guias de pagamento em PDF com facilidade</p>
    </header>

    <div class="container">
        <div id="processos-container">
            <!-- Os processos serão adicionados aqui dinamicamente -->
        </div>

        <div class="acoes">
            <div class="nome-processo-container">
                <label for="nome-processo">Nº do processo:</label>
                <input type="text" id="nome-processo" class="nome-processo" placeholder="Digite o número do processo">
            </div>
            <div class="botoes-acao">
                <button id="btn-adicionar-processo" class="btn-acao btn-adicionar">+ Adicionar Boleto ao processo</button>
                <button id="btn-juntar-pdfs" class="btn-acao btn-juntar">Juntar Comprovante</button>
                <button id="btn-limpar-tudo" class="btn-acao btn-limpar-tudo">Limpar Tudo</button>
            </div>
        </div>
    </div>

    <footer>
        <p>Desenvolvido por IAlexYagamiI com DeepSeek para facilitar rotina de juntar guias.</p>
        <br>
        <p>Versão do projeto: 3.0 (GCC - COMPESA)</p>
    </footer>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #e4ebf7;
            color: #333;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .processo {
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9fafc;
        }

        .processo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e8ed;
        }

        .filtro-container {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 10px;
        }

        .filtro-texto {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .checkbox-filtro {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .checkbox-filtro input {
            width: 18px;
            height: 18px;
        }

        .remover-processo {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remover-processo:hover {
            background-color: #c0392b;
        }

        .area-arquivos {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .area-arquivo {
            flex: 1;
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .area-arquivo:hover {
            border-color: #3498db;
            background-color: #f0f8ff;
        }

        .area-arquivo.highlight {
            border-color: #3498db;
            background-color: #e1f0fa;
        }

        .area-arquivo h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .area-arquivo p {
            margin-bottom: 15px;
            color: #7f8c8d;
        }

        .btn-arquivo {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
            transition: background-color 0.3s;
        }

        .btn-arquivo:hover {
            background-color: #2980b9;
        }

        .btn-limpar {
            background-color: #44ce57;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
            transition: background-color 0.3s;
            font-size: 14px;
        }

        .btn-limpar:hover {
            background-color: #d35400;
        }

        .paginas-container {
            margin-top: 15px;
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            padding: 10px;
            background-color: #cad5da;
        }

        .pag-nao-corresp{
            font-weight: bold;
        }
        .pagina-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .pagina-item:hover {
            background-color: #edf2f7;
        }

        .pagina-item.selecionada {
            background-color: #e1f0fa;
        }

        .checkbox-pagina {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .acoes {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .nome-processo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .nome-processo-container label {
            font-weight: bold;
            color: #2c3e50;
        }

        .nome-processo {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .botoes-acao {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .btn-acao {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-adicionar {
            background-color: #2ecc71;
            color: white;
        }

        .btn-adicionar:hover {
            background-color: #27ae60;
        }

        .btn-juntar {
            background-color: #101ed9;
            color: white;
        }

        .btn-juntar:hover {
            background-color: #0f189e;
        }

        .btn-limpar-tudo {
            background-color: #e67e22;
            color: white;
        }

        .btn-limpar-tudo:hover {
            background-color: #d35400;
        }

        .info-arquivo {
            margin-top: 10px;
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
        }

        .oculto {
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .area-arquivos {
                flex-direction: column;
            }
            
            .processo-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .filtro-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .botoes-acao {
                flex-direction: column;
            }
        }
    </style>

    <script>
        // Configuração do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // Array para armazenar dados de todos os processos
        let processos = [];
        let contadorProcessos = 0;

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            adicionarProcesso(); // Adiciona o primeiro processo ao carregar a página
            
            // Event listeners para os botões principais
            document.getElementById('btn-adicionar-processo').addEventListener('click', adicionarProcesso);
            document.getElementById('btn-juntar-pdfs').addEventListener('click', juntarPDFs);
            document.getElementById('btn-limpar-tudo').addEventListener('click', limparTudo);
        });

        // Função para limpar todos os campos (exceto documento 1 do primeiro processo)
        function limparTudo() {
            if (!confirm('Isso irá limpar todos os campos e processos adicionais, mantendo apenas o primeiro processo com seu documento 1. Deseja continuar?')) {
                return;
            }
            
            // Remove todos os processos exceto o primeiro
            const processosContainer = document.getElementById('processos-container');
            const todosProcessos = processosContainer.querySelectorAll('.processo');
            
            for (let i = todosProcessos.length - 1; i > 0; i--) {
                todosProcessos[i].remove();
            }
            
            // Limpa os campos do primeiro processo, exceto o documento 1
            const processo0 = processos[0];
            if (processo0) {
                // Limpa o campo de filtro
                document.querySelector('.filtro-texto[data-processo="0"]').value = '';
                
                // Limpa o segundo arquivo
                processo0.arquivo2 = null;
                processo0.paginasComTexto2 = [];
                processo0.paginasSelecionadas2 = [];
                processo0.paginasFiltradas2 = [];
                
                // Atualiza a interface do segundo arquivo
                document.getElementById('info-arquivo-2-0').textContent = '';
                document.getElementById('paginas-2-0').innerHTML = '';
                document.getElementById('input-arquivo-2-0').value = '';
                
                // Reseta as seleções do primeiro arquivo
                processo0.paginasSelecionadas1 = [];
                
                // Atualiza a interface do primeiro arquivo (mantém o arquivo, apenas limpa seleções)
                if (processo0.arquivo1) {
                    document.getElementById('info-arquivo-1-0').textContent = `Arquivo: ${processo0.arquivo1.name}`;
                    exibirPaginas(0, 1, processo0.paginasComTexto1);
                }
                
                // Reseta o checkbox de filtro
                document.getElementById('filtro-segundo-0').checked = true;
                processo0.filtrarSegundo = true;
            }
            
            // Reseta o array de processos para conter apenas o primeiro
            processos = [processos[0]];
            contadorProcessos = 1;
            
            // Limpa o campo do nome do processo
            document.getElementById('nome-processo').value = '';
        }

        // Função para adicionar um novo processo
        function adicionarProcesso() {
            const processosContainer = document.getElementById('processos-container');
            const idProcesso = contadorProcessos++;
            
            // Sempre duplica o documento 1 do primeiro processo (se existir)
            let arquivo1Duplicado = null;
            if (idProcesso > 0 && processos[0] && processos[0].arquivo1) {
                arquivo1Duplicado = processos[0].arquivo1;
            }
            
            const processoHTML = `
                <div class="processo" id="processo-${idProcesso}">
                    <div class="processo-header">
                        <div class="filtro-container">
                            <input type="text" class="filtro-texto" placeholder="Digite o NOSSO NÚMERO do comprovante e boleto." data-processo="${idProcesso}">
                            <div class="checkbox-filtro">
                                <input type="checkbox" id="filtro-segundo-${idProcesso}" data-processo="${idProcesso}" checked>
                                <label for="filtro-segundo-${idProcesso}">Checar <b>nosso número</b> em ambos</label>
                            </div>
                        </div>
                        <button class="remover-processo ${idProcesso === 0 ? 'oculto' : ''}">✕</button>
                    </div>
                    <div class="area-arquivos">
                        <div class="area-arquivo" id="area-arquivo-1-${idProcesso}">
                            <h3>Comprovante Geral:</h3>
                            <p>Arraste o arquivo aqui ou</p>
                            <input type="file" class="oculto" accept=".pdf" id="input-arquivo-1-${idProcesso}">
                            <button class="btn-arquivo" data-tipo="1" data-processo="${idProcesso}">Selecione o Arquivo</button>
                            <button class="btn-limpar" data-tipo="1" data-processo="${idProcesso}">Limpar</button>
                            <div class="info-arquivo" id="info-arquivo-1-${idProcesso}"></div>
                            <div class="paginas-container" id="paginas-1-${idProcesso}"></div>
                        </div>
                        <div class="area-arquivo" id="area-arquivo-2-${idProcesso}">
                            <h3>Boleto</h3>
                            <p>Arraste o arquivo aqui ou</p>
                            <input type="file" class="oculto" accept=".pdf" id="input-arquivo-2-${idProcesso}">
                            <button class="btn-arquivo" data-tipo="2" data-processo="${idProcesso}">Selecione o Arquivo</button>
                            <button class="btn-limpar" data-tipo="2" data-processo="${idProcesso}">Limpar</button>
                            <div class="info-arquivo" id="info-arquivo-2-${idProcesso}"></div>
                            <div class="paginas-container" id="paginas-2-${idProcesso}"></div>
                        </div>
                    </div>
                </div>
            `;
            
            processosContainer.insertAdjacentHTML('beforeend', processoHTML);
            
            // Inicializar dados do processo
            processos[idProcesso] = {
                arquivo1: arquivo1Duplicado,
                arquivo2: null,
                paginasFiltradas1: [],
                paginasSelecionadas1: [],
                paginasComTexto1: [],
                paginasFiltradas2: [],
                paginasSelecionadas2: [],
                paginasComTexto2: [],
                filtrarSegundo: true  // Agora padrão é true
            };
            
            // Configurar event listeners para este processo
            configurarProcesso(idProcesso);
            
            // Se há um arquivo para duplicar, carregá-lo
            if (arquivo1Duplicado) {
                document.getElementById(`info-arquivo-1-${idProcesso}`).textContent = `Arquivo: ${arquivo1Duplicado.name}`;
                // Duplica também os dados de texto extraídos do primeiro processo
                if (processos[0] && processos[0].paginasComTexto1) {
                    processos[idProcesso].paginasComTexto1 = JSON.parse(JSON.stringify(processos[0].paginasComTexto1));
                    exibirPaginas(idProcesso, 1, processos[idProcesso].paginasComTexto1);
                } else {
                    extrairTextoPaginas(arquivo1Duplicado, 1, idProcesso);
                }
            }
        }

        // Configurar eventos para um processo específico
        function configurarProcesso(idProcesso) {
            // Event listeners para os botões de seleção de arquivo
            document.querySelectorAll(`.btn-arquivo[data-processo="${idProcesso}"]`).forEach(btn => {
                btn.addEventListener('click', function() {
                    const tipo = this.getAttribute('data-tipo');
                    const inputArquivo = document.getElementById(`input-arquivo-${tipo}-${idProcesso}`);
                    
                    // Para o documento 1 de processos adicionais, se não há arquivo, tenta duplicar do primeiro processo
                    if (tipo === '1' && idProcesso > 0 && !processos[idProcesso].arquivo1 && processos[0] && processos[0].arquivo1) {
                        const arquivoDuplicado = processos[0].arquivo1;
                        carregarArquivo(arquivoDuplicado, 1, idProcesso);
                    } else {
                        inputArquivo.click();
                    }
                });
            });
            
            // Event listeners para os botões de limpar
            document.querySelectorAll(`.btn-limpar[data-processo="${idProcesso}"]`).forEach(btn => {
                btn.addEventListener('click', function() {
                    const tipo = this.getAttribute('data-tipo');
                    const idProcesso = this.getAttribute('data-processo');
                    
                    // Se for o campo 1 do primeiro processo, pedir confirmação
                    if (tipo === '1' && idProcesso === '0') {
                        if (!confirm('Tem certeza que deseja limpar o documento 1 do primeiro processo? Isso afetará todos os processos que dependem dele.')) {
                            return;
                        }
                    }
                    
                    limparArquivo(tipo, idProcesso);
                });
            });
            
            // Event listeners para os inputs de arquivo
            document.getElementById(`input-arquivo-1-${idProcesso}`).addEventListener('change', function(e) {
                carregarArquivo(e.target.files[0], 1, idProcesso);
            });
            
            document.getElementById(`input-arquivo-2-${idProcesso}`).addEventListener('change', function(e) {
                carregarArquivo(e.target.files[0], 2, idProcesso);
            });
            
            // Event listeners para áreas de drop
            const areaArquivo1 = document.getElementById(`area-arquivo-1-${idProcesso}`);
            const areaArquivo2 = document.getElementById(`area-arquivo-2-${idProcesso}`);
            
            configurarAreaDrop(areaArquivo1, 1, idProcesso);
            configurarAreaDrop(areaArquivo2, 2, idProcesso);
            
            // Event listener para o campo de filtro
            document.querySelector(`.filtro-texto[data-processo="${idProcesso}"]`).addEventListener('input', function() {
                filtrarPaginas(this.value, idProcesso);
            });
            
            // Event listener para o checkbox de filtro do segundo PDF
            document.getElementById(`filtro-segundo-${idProcesso}`).addEventListener('change', function() {
                processos[idProcesso].filtrarSegundo = this.checked;
                if (this.checked && processos[idProcesso].arquivo2) {
                    extrairTextoPaginas(processos[idProcesso].arquivo2, 2, idProcesso);
                } else if (!this.checked) {
                    // Limpar a seleção do segundo PDF
                    processos[idProcesso].paginasSelecionadas2 = [];
                    document.getElementById(`paginas-2-${idProcesso}`).innerHTML = '';
                }
                // Executar a pesquisa sempre que o checkbox mudar
                const textoFiltro = document.querySelector(`.filtro-texto[data-processo="${idProcesso}"]`).value;
                filtrarPaginas(textoFiltro, idProcesso);
            });
            
            // Event listener para o botão de remover (se não for o primeiro processo)
            const btnRemover = document.querySelector(`#processo-${idProcesso} .remover-processo`);
            if (btnRemover && !btnRemover.classList.contains('oculto')) {
                btnRemover.addEventListener('click', function() {
                    removerProcesso(idProcesso);
                });
            }
        }

        // Configurar área de drop para arquivos
        function configurarAreaDrop(area, tipo, idProcesso) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                area.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                area.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                area.classList.add('highlight');
            }
            
            function unhighlight() {
                area.classList.remove('highlight');
            }
            
            area.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                carregarArquivo(files[0], tipo, idProcesso);
            }, false);
        }

        // Carregar arquivo PDF
        async function carregarArquivo(arquivo, tipo, idProcesso) {
            if (!arquivo || arquivo.type !== 'application/pdf') {
                alert('Por favor, selecione um arquivo PDF válido.');
                return;
            }
            
            // Atualizar interface
            document.getElementById(`info-arquivo-${tipo}-${idProcesso}`).textContent = `Arquivo: ${arquivo.name}`;
            
            // Armazenar arquivo no objeto do processo
            if (tipo === 1) {
                processos[idProcesso].arquivo1 = arquivo;
                // Carregar e extrair texto das páginas
                await extrairTextoPaginas(arquivo, tipo, idProcesso);
            } else {
                processos[idProcesso].arquivo2 = arquivo;
                // Se o filtro do segundo PDF está ativo, extrair texto
                if (processos[idProcesso].filtrarSegundo) {
                    await extrairTextoPaginas(arquivo, tipo, idProcesso);
                }
            }
            
            // Executar a pesquisa sempre que um novo arquivo for carregado
            const textoFiltro = document.querySelector(`.filtro-texto[data-processo="${idProcesso}"]`).value;
            filtrarPaginas(textoFiltro, idProcesso);
        }

        // Limpar arquivo
        function limparArquivo(tipo, idProcesso) {
            if (tipo == 1) {
                processos[idProcesso].arquivo1 = null;
                processos[idProcesso].paginasComTexto1 = [];
                processos[idProcesso].paginasSelecionadas1 = [];
                document.getElementById(`info-arquivo-1-${idProcesso}`).textContent = '';
                document.getElementById(`paginas-1-${idProcesso}`).innerHTML = '';
                document.getElementById(`input-arquivo-1-${idProcesso}`).value = '';
            } else {
                processos[idProcesso].arquivo2 = null;
                processos[idProcesso].paginasComTexto2 = [];
                processos[idProcesso].paginasSelecionadas2 = [];
                document.getElementById(`info-arquivo-2-${idProcesso}`).textContent = '';
                document.getElementById(`paginas-2-${idProcesso}`).innerHTML = '';
                document.getElementById(`input-arquivo-2-${idProcesso}`).value = '';
            }
            
            // Executar a pesquisa sempre que um arquivo for limpo
            const textoFiltro = document.querySelector(`.filtro-texto[data-processo="${idProcesso}"]`).value;
            filtrarPaginas(textoFiltro, idProcesso);
        }

        // Extrair texto de todas as páginas do PDF
        async function extrairTextoPaginas(arquivo, tipo, idProcesso) {
            const arrayBuffer = await arquivo.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const numPages = pdf.numPages;
            
            if (tipo === 1) {
                processos[idProcesso].paginasComTexto1 = [];
            } else {
                processos[idProcesso].paginasComTexto2 = [];
            }
            
            for (let i = 1; i <= numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const text = textContent.items.map(item => item.str).join(' ');
                
                if (tipo === 1) {
                    processos[idProcesso].paginasComTexto1.push({
                        numero: i,
                        texto: text
                    });
                } else {
                    processos[idProcesso].paginasComTexto2.push({
                        numero: i,
                        texto: text
                    });
                }
            }
            
            // Exibir todas as páginas inicialmente
            if (tipo === 1) {
                exibirPaginas(idProcesso, tipo, processos[idProcesso].paginasComTexto1);
            } else {
                exibirPaginas(idProcesso, tipo, processos[idProcesso].paginasComTexto2);
            }
            
            // Executar a pesquisa sempre que o texto for extraído
            const textoFiltro = document.querySelector(`.filtro-texto[data-processo="${idProcesso}"]`).value;
            filtrarPaginas(textoFiltro, idProcesso);
        }

        // Exibir páginas na interface
        function exibirPaginas(idProcesso, tipo, paginas) {
            const container = document.getElementById(`paginas-${tipo}-${idProcesso}`);
            container.innerHTML = '';
            
            if (paginas.length === 0) {
                container.innerHTML = '<p class="pag-nao-corresp">Nenhuma página corresponde ao filtro.</p>';
                return;
            }
            
            paginas.forEach(pagina => {
                const paginaElement = document.createElement('div');
                paginaElement.className = 'pagina-item';
                paginaElement.setAttribute('data-pagina', pagina.numero);
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'checkbox-pagina';
                
                if (tipo === 1) {
                    checkbox.checked = processos[idProcesso].paginasSelecionadas1.includes(pagina.numero);
                } else {
                    checkbox.checked = processos[idProcesso].paginasSelecionadas2.includes(pagina.numero);
                }
                
                const label = document.createElement('span');
                label.textContent = `Página ${pagina.numero}`;
                
                checkbox.addEventListener('change', function() {
                    toggleSelecionarPagina(idProcesso, pagina.numero, this.checked, paginaElement, tipo);
                });
                
                paginaElement.appendChild(checkbox);
                paginaElement.appendChild(label);
                
                // Verificar se esta página está selecionada
                if ((tipo === 1 && processos[idProcesso].paginasSelecionadas1.includes(pagina.numero)) ||
                    (tipo === 2 && processos[idProcesso].paginasSelecionadas2.includes(pagina.numero))) {
                    paginaElement.classList.add('selecionada');
                }
                
                container.appendChild(paginaElement);
            });
            
            // Se há apenas uma página, selecioná-la automaticamente
            if (paginas.length === 1) {
                const unicaPagina = paginas[0].numero;
                if (tipo === 1) {
                    if (!processos[idProcesso].paginasSelecionadas1.includes(unicaPagina)) {
                        processos[idProcesso].paginasSelecionadas1.push(unicaPagina);
                        const checkbox = container.querySelector('.checkbox-pagina');
                        if (checkbox) {
                            checkbox.checked = true;
                            container.querySelector('.pagina-item').classList.add('selecionada');
                        }
                    }
                } else {
                    if (!processos[idProcesso].paginasSelecionadas2.includes(unicaPagina)) {
                        processos[idProcesso].paginasSelecionadas2.push(unicaPagina);
                        const checkbox = container.querySelector('.checkbox-pagina');
                        if (checkbox) {
                            checkbox.checked = true;
                            container.querySelector('.pagina-item').classList.add('selecionada');
                        }
                    }
                }
            }
            
            // Atualizar lista de páginas filtradas
            if (tipo === 1) {
                processos[idProcesso].paginasFiltradas1 = paginas.map(p => p.numero);
            } else {
                processos[idProcesso].paginasFiltradas2 = paginas.map(p => p.numero);
            }
        }

        // Alternar seleção de página
        function toggleSelecionarPagina(idProcesso, numeroPagina, selecionado, elemento, tipo) {
            if (selecionado) {
                // Adicionar à seleção
                if (tipo === 1) {
                    if (!processos[idProcesso].paginasSelecionadas1.includes(numeroPagina)) {
                        processos[idProcesso].paginasSelecionadas1.push(numeroPagina);
                    }
                } else {
                    if (!processos[idProcesso].paginasSelecionadas2.includes(numeroPagina)) {
                        processos[idProcesso].paginasSelecionadas2.push(numeroPagina);
                    }
                }
                elemento.classList.add('selecionada');
            } else {
                // Remover da seleção
                if (tipo === 1) {
                    const index = processos[idProcesso].paginasSelecionadas1.indexOf(numeroPagina);
                    if (index !== -1) {
                        processos[idProcesso].paginasSelecionadas1.splice(index, 1);
                    }
                } else {
                    const index = processos[idProcesso].paginasSelecionadas2.indexOf(numeroPagina);
                    if (index !== -1) {
                        processos[idProcesso].paginasSelecionadas2.splice(index, 1);
                    }
                }
                elemento.classList.remove('selecionada');
            }
        }

        // Filtrar páginas com base no texto
        function filtrarPaginas(textoFiltro, idProcesso) {
            // Função auxiliar para atualizar seleções com base no filtro
            function atualizarSelecoes(paginasFiltradas, paginasSelecionadas) {
                // Remove das seleções as páginas que não estão nas páginas filtradas
                return paginasSelecionadas.filter(numero => 
                    paginasFiltradas.some(p => p.numero === numero)
                );
            }
            
            // Filtrar primeiro PDF
            if (processos[idProcesso].paginasComTexto1) {
                let paginasFiltradas1;
                if (!textoFiltro.trim()) {
                    // Se o filtro estiver vazio, mostrar todas as páginas
                    paginasFiltradas1 = processos[idProcesso].paginasComTexto1;
                } else {
                    const textoLower = textoFiltro.toLowerCase();
                    paginasFiltradas1 = processos[idProcesso].paginasComTexto1.filter(
                        pagina => pagina.texto.toLowerCase().includes(textoLower)
                    );
                }
                
                // Atualizar seleções do primeiro PDF - remover páginas que não correspondem ao filtro
                processos[idProcesso].paginasSelecionadas1 = atualizarSelecoes(
                    paginasFiltradas1,
                    processos[idProcesso].paginasSelecionadas1
                );
                
                exibirPaginas(idProcesso, 1, paginasFiltradas1);
            }
            
            // Filtrar segundo PDF se o filtro estiver ativo
            if (processos[idProcesso].filtrarSegundo && processos[idProcesso].paginasComTexto2) {
                let paginasFiltradas2;
                if (!textoFiltro.trim()) {
                    // Se o filtro estiver vazio, mostrar todas as páginas
                    paginasFiltradas2 = processos[idProcesso].paginasComTexto2;
                } else {
                    const textoLower = textoFiltro.toLowerCase();
                    paginasFiltradas2 = processos[idProcesso].paginasComTexto2.filter(
                        pagina => pagina.texto.toLowerCase().includes(textoLower)
                    );
                }
                
                // Atualizar seleções do segundo PDF - remover páginas que não correspondem ao filtro
                processos[idProcesso].paginasSelecionadas2 = atualizarSelecoes(
                    paginasFiltradas2,
                    processos[idProcesso].paginasSelecionadas2
                );
                
                exibirPaginas(idProcesso, 2, paginasFiltradas2);
            }
        }

        // Remover um processo
        function removerProcesso(idProcesso) {
            const processoElement = document.getElementById(`processo-${idProcesso}`);
            if (processoElement) {
                processoElement.remove();
                delete processos[idProcesso];
            }
        }

        // Verificar se há processos sem segundo PDF
        function verificarProcessosSemSegundoPDF() {
            const processosSemSegundo = [];
            
            for (let i = 0; i < processos.length; i++) {
                if (processos[i] && !processos[i].arquivo2) {
                    processosSemSegundo.push(i + 1); // +1 para mostrar número começando em 1
                }
            }
            
            return processosSemSegundo;
        }

        // Juntar todos os PDFs
        async function juntarPDFs() {
            // Verificar se há processos sem segundo PDF
            const processosSemSegundo = verificarProcessosSemSegundoPDF();
            const nomeProcesso = document.getElementById('nome-processo').value.trim();
            let mensagemConfirmacao = '';
            
            // Verificar se o nome do processo está em branco
            if (!nomeProcesso) {
                mensagemConfirmacao += 'Nome do processo está em branco.\n\n';
            }
            
            // Verificar se há processos sem segundo PDF
            if (processosSemSegundo.length > 0) {
                mensagemConfirmacao += `Os seguintes processos não têm um segundo PDF: ${processosSemSegundo.join(', ')}.\n\n`;
            }
            
            // Se houver algo para confirmar, mostrar a mensagem
            if (mensagemConfirmacao) {
                mensagemConfirmacao += 'Deseja continuar mesmo assim? Clique em "Cancelar" para corrigir os problemas.';
                
                if (!confirm(mensagemConfirmacao)) {
                    return; // Usuário cancelou
                }
            }
            
            try {
                const pdfFinal = await PDFLib.PDFDocument.create();
                
                // Processar cada processo sequencialmente
                for (let i = 0; i < processos.length; i++) {
                    if (!processos[i]) continue;
                    
                    // Adicionar páginas selecionadas do primeiro PDF
                    if (processos[i].arquivo1 && processos[i].paginasSelecionadas1.length > 0) {
                        const arrayBuffer1 = await processos[i].arquivo1.arrayBuffer();
                        const pdf1 = await PDFLib.PDFDocument.load(arrayBuffer1);
                        
                        for (const numeroPagina of processos[i].paginasSelecionadas1) {
                            const [pagina] = await pdfFinal.copyPages(pdf1, [numeroPagina - 1]); // PDFLib usa índice 0-based
                            pdfFinal.addPage(pagina);
                        }
                    }
                    
                    // Adicionar páginas do segundo PDF
                    if (processos[i].arquivo2) {
                        const arrayBuffer2 = await processos[i].arquivo2.arrayBuffer();
                        const pdf2 = await PDFLib.PDFDocument.load(arrayBuffer2);
                        
                        if (processos[i].filtrarSegundo && processos[i].paginasSelecionadas2.length > 0) {
                            // Se o filtro está ativo, adicionar apenas as páginas selecionadas
                            for (const numeroPagina of processos[i].paginasSelecionadas2) {
                                const [pagina] = await pdfFinal.copyPages(pdf2, [numeroPagina - 1]);
                                pdfFinal.addPage(pagina);
                            }
                        } else {
                            // Se o filtro não está ativo, adicionar todas as páginas
                            const paginas2 = pdf2.getPages();
                            for (let j = 0; j < paginas2.length; j++) {
                                const [pagina] = await pdfFinal.copyPages(pdf2, [j]);
                                pdfFinal.addPage(pagina);
                            }
                        }
                    }
                }
                
                // Salvar e baixar o PDF final
                const pdfBytes = await pdfFinal.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = nomeProcesso ? `PROC ${nomeProcesso}.pdf` : 'Documento Combinado - Junta Guias IAlekI.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                //alert('PDF combinado com sucesso! O download começará automaticamente.');
                
            } catch (error) {
                console.error('Erro ao juntar PDFs:', error);
                alert('Erro ao juntar os PDFs. Verifique se todos os arquivos foram carregados corretamente.');
            }
        }
    </script>
</body>
</html>
